<!DOCTYPE html>
<html>
<head>
    <title>自动备份系统</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{{ url_for('static', filename='css/materialdesignicons.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1976D2;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #f44336;
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #333;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), #2196F3);
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-panel {
            display: flex;
            gap: 20px;
        }

        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            min-width: 150px;
        }

        .status-item-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .status-item-value {
            font-size: 1.2em;
            font-weight: 500;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .task-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .task-title {
            font-size: 1.2em;
            font-weight: 500;
            color: var(--primary-color);
        }

        .task-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-active {
            background: #E8F5E9;
            color: var(--success-color);
        }

        .task-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
        }

        .task-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .task-info-item:last-child {
            border-bottom: none;
        }

        .task-info-label {
            color: #666;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .button {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            gap: 5px;
        }

        .button i {
            font-size: 1.2em;
        }

        .button-primary {
            background: var(--primary-color);
        }

        .button-success {
            background: var(--success-color);
        }

        .button-danger {
            background: var(--danger-color);
        }

        .button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .log-container {
            background: #1E1E1E;
            color: #fff;
            padding: 15px;
            border-radius: var(--border-radius);
            height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .log-entry {
            padding: 5px 10px;
            border-left: 3px solid transparent;
        }

        .log-error {
            border-left-color: var(--danger-color);
            color: #ff8a80;
        }

        .log-success {
            border-left-color: var(--success-color);
            color: #b9f6ca;
        }

        .log-warning {
            border-left-color: var(--warning-color);
            color: #ffe57f;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-title {
            color: #666;
            font-size: 0.9em;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .status-panel {
                flex-direction: column;
                gap: 10px;
            }

            .button-group {
                flex-direction: column;
            }

            .button {
                width: 100%;
                justify-content: center;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: modal-in 0.3s ease-out;
        }

        @keyframes modal-in {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .form-group small {
            display: block;
            color: #666;
            margin-top: 5px;
            font-size: 12px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .progress-bar {
            height: 4px;
            width: 100%;
            background: #eee;
            margin-top: 15px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-value {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary-color), #2196F3);
            transition: width 0.3s ease-in-out;
        }

        .history-list {
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .history-item-time {
            color: #666;
            font-size: 0.9em;
        }

        .history-success {
            color: var(--success-color);
            font-weight: 500;
        }

        .history-failed {
            color: var(--danger-color);
            font-weight: 500;
        }

        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            z-index: 1100;
        }

        .notification-show {
            transform: translateX(0);
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .notification-message {
            color: #666;
            font-size: 0.9em;
        }

        .notification-success {
            border-left: 4px solid var(--success-color);
        }

        .notification-error {
            border-left: 4px solid var(--danger-color);
        }

        .notification-info {
            border-left: 4px solid var(--primary-color);
        }

        /* 添加动作菜单 */
        .task-actions {
            position: relative;
        }

        .task-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 150px;
            z-index: 100;
            display: none;
        }

        .task-menu.show {
            display: block;
            animation: menu-in 0.2s ease-out;
        }

        @keyframes menu-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-menu-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .task-menu-item:hover {
            background-color: #f5f5f5;
        }

        .task-menu-item i {
            font-size: 1.2em;
        }

        /* 添加标签样式 */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            gap: 4px;
        }

        .tag-success {
            background: #E8F5E9;
            color: var(--success-color);
        }

        .tag-warning {
            background: #FFF3E0;
            color: var(--warning-color);
        }

        .tag-danger {
            background: #FFEBEE;
            color: var(--danger-color);
        }

        /* 添加卡片悬浮效果 */
        .hover-card {
            transition: all 0.3s;
        }

        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* 添加进度指示器 */
        .task-progress {
            position: relative;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .task-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #2196F3);
            transition: width 0.3s ease-in-out;
        }

        /* 添加动画效果 */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        /* 添加滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* 添加模态框过渡效果 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        /* 添加加载中状态 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1200;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* 添加响应式调整 */
        @media (max-width: 480px) {
            .notification {
                min-width: auto;
                width: calc(100% - 40px);
            }

            .modal-content {
                width: calc(100% - 40px);
            }

            .button {
                padding: 8px 12px;
                font-size: 0.85em;
            }
        }

        .history-list {
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: translateX(5px);
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-info {
            flex: 1;
            margin-right: 20px;
        }

        .history-task {
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .history-time {
            font-size: 0.9em;
            color: #666;
        }

        .history-details {
            flex: 2;
            color: #666;
        }

        .history-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .history-status.success {
            background: #E8F5E9;
            color: var(--success-color);
        }

        .history-status.failed {
            background: #FFEBEE;
            color: var(--danger-color);
        }

        .status-running {
            color: var(--warning-color) !important;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>自动备份系统</h1>
                <div class="status-panel">
                    <div class="status-item">
                        <div class="status-item-title">系统状态</div>
                        <div class="status-item-value" id="system-status">
                            <i class="mdi mdi-check-circle"></i> 正常运行
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">最后备份时间</div>
                        <div class="status-item-value" id="last-backup-time">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">CPU 使用率</div>
                        <div class="status-item-value" id="cpuUsage">0%</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">内存使用率</div>
                        <div class="status-item-value" id="memoryUsage">0%</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">磁盘使用率</div>
                        <div class="status-item-value" id="diskUsage">0%</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">备份状态</div>
                        <div class="status-item-value" id="backupStatus">
                            <i class="mdi mdi-check-circle"></i> 空闲
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>备份任务</h2>
                <button class="button button-primary" onclick="showAddTaskDialog()">
                    <i class="mdi mdi-plus"></i> 添加任务
                </button>
            </div>
            <div class="grid">
                {% for name, task in tasks.items() %}
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">{{ name }}</div>
                        <span class="task-status status-active">
                            <i class="mdi mdi-check-circle"></i> 已启用
                        </span>
                    </div>
                    <div class="task-info">
                        <div class="task-info-item">
                            <span class="task-info-label">源路径</span>
                            <span>{{ task.source_path }}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">目标服务器</span>
                            <span>{{ task.target_server }}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">目标路径</span>
                            <span>{{ task.target_path }}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">调度</span>
                            <span>{{ task.schedule }}</span>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="button button-success" onclick="runBackup('{{ name }}')" data-tooltip="立即执行备份任务">
                            <i class="mdi mdi-play"></i> 立即执行
                        </button>
                        <button class="button button-primary" onclick="editTask('{{ name }}')" data-tooltip="编辑任务配置">
                            <i class="mdi mdi-pencil"></i> 编辑
                        </button>
                        <button class="button button-danger" onclick="deleteTask('{{ name }}')" data-tooltip="删除此任务">
                            <i class="mdi mdi-delete"></i> 删除
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>备份统计</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">总备份次数</div>
                    <div class="stat-value" id="totalBackups">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">成功率</div>
                    <div class="stat-value" id="successRate">0%</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="taskChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>备份历史</h2>
                <button class="button button-primary" onclick="clearHistory()">
                    <i class="mdi mdi-delete"></i> 清除历史
                </button>
            </div>
            <div id="historyList" class="history-list">
                <!-- 历史记录将在这里动态插入 -->
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>实时日志</h2>
                <button class="button button-primary" onclick="clearLogs()">
                    <i class="mdi mdi-delete"></i> 清除日志
                </button>
            </div>
            <div class="log-container" id="logs"></div>
        </div>
    </div>

    <!-- 服务器管理对话框 -->
    <div id="serverDialog" class="modal">
        <div class="modal-content">
            <h2 id="dialogTitle">添加服务器</h2>
            <form id="serverForm">
                <input type="hidden" id="serverAction" value="add">
                <div class="form-group">
                    <label>服务器名称:</label>
                    <input type="text" id="serverName" required>
                </div>
                <div class="form-group">
                    <label>主机地址:</label>
                    <input type="text" id="serverHost" required>
                </div>
                <div class="form-group">
                    <label>端口:</label>
                    <input type="number" id="serverPort" value="22" required>
                </div>
                <div class="form-group">
                    <label>用户名:</label>
                    <input type="text" id="serverUsername" required>
                </div>
                <div class="form-group">
                    <label>密码:</label>
                    <input type="password" id="serverPassword">
                </div>
                <div class="form-actions">
                    <button type="button" class="button button-secondary" onclick="testServerConnection()">测试连接</button>
                    <button type="submit" class="button">保存</button>
                    <button type="button" class="button button-danger" onclick="closeServerDialog()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 任务管理对话框 -->
    <div id="taskDialog" class="modal">
        <div class="modal-content">
            <h2 id="taskDialogTitle">添加任务</h2>
            <form id="taskForm">
                <input type="hidden" id="taskAction" value="add">
                <div class="form-group">
                    <label>任务名称:</label>
                    <input type="text" id="taskName" required>
                </div>
                <div class="form-group">
                    <label>源路径:</label>
                    <input type="text" id="sourcePath" required>
                </div>
                <div class="form-group">
                    <label>目标服务器:</label>
                    <select id="targetServer" required>
                        {% for name, server in servers.items() %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>目标路径:</label>
                    <input type="text" id="targetPath" required>
                </div>
                <div class="form-group">
                    <label>调度:</label>
                    <input type="text" id="schedule" required placeholder="*/5 * * * *">
                    <small>Cron 格式，例如: */5 * * * * 表示每5分钟执行一次</small>
                </div>
                <div class="form-group">
                    <label>重试次数:</label>
                    <input type="number" id="retryTimes" value="3" required>
                </div>
                <div class="form-group">
                    <label>重试间隔(秒):</label>
                    <input type="number" id="retryInterval" value="30" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button">保存</button>
                    <button type="button" class="button button-danger" onclick="closeTaskDialog()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 保持原有的脚本部分不变 -->
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <script>
        // 从服务器端传递的数据
        var tasks = {{ tasks|tojson|safe }};
        var servers = {{ servers|tojson|safe }};

        // 更新日志
        function updateLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    if (data.logs) {
                        const logsDiv = document.getElementById('logs');
                        const formattedLogs = data.logs.map(log => {
                            let className = 'log-entry';
                            if (log.includes('ERROR')) className += ' log-error';
                            if (log.includes('SUCCESS') || log.includes('成功')) className += ' log-success';
                            if (log.includes('WARNING')) className += ' log-warning';
                            return `<div class="${className}">${log}</div>`;
                        });
                        logsDiv.innerHTML = formattedLogs.join('');
                        logsDiv.scrollTop = logsDiv.scrollHeight;
                    }
                });
        }

        // 执行备份
        function runBackup(taskName) {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading"></div> 执行中...';
            button.disabled = true;
            
            fetch('/api/run_backup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({task_name: taskName})
            })
            .then(response => response.json())
            .then(data => {
                button.innerHTML = originalText;
                button.disabled = false;
                if (data.success) {
                    showNotification('成功', data.message, 'success');
                } else {
                    showNotification('失败', data.message, 'error');
                }
                updateLastBackupTime();
            })
            .catch(error => {
                button.innerHTML = originalText;
                button.disabled = false;
                showNotification('错误', error.message, 'error');
            });
        }

        // 查看任务日志
        function viewTaskLogs(taskName) {
            // 可以添加查看特定任务日志的功能
            alert('查看任务日志功能开发中...');
        }

        // 清除日志
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // 更新最后备份时间
        function updateLastBackupTime() {
            const now = new Date();
            document.getElementById('last-backup-time').textContent = 
                now.toLocaleString('zh-CN');
        }

        // 定期更新
        setInterval(updateLogs, 5000);
        updateLogs();

        // 初始化
        updateLastBackupTime();

        // 显示添加服务器对话框
        function showAddServerDialog() {
            document.getElementById('dialogTitle').textContent = '添加服务器';
            document.getElementById('serverAction').value = 'add';
            document.getElementById('serverForm').reset();
            document.getElementById('serverDialog').style.display = 'flex';
        }

        // 显示编辑服务器对话框
        function editServer(serverName) {
            const server = servers[serverName];
            document.getElementById('dialogTitle').textContent = '编辑服务器';
            document.getElementById('serverAction').value = 'edit';
            document.getElementById('serverName').value = serverName;
            document.getElementById('serverHost').value = server.host;
            document.getElementById('serverPort').value = server.port;
            document.getElementById('serverUsername').value = server.username;
            document.getElementById('serverDialog').style.display = 'flex';
        }

        // 关闭对话框
        function closeServerDialog() {
            document.getElementById('serverDialog').style.display = 'none';
        }

        // 测试服务器连接
        function testServerConnection() {
            const serverData = {
                host: document.getElementById('serverHost').value,
                port: document.getElementById('serverPort').value,
                username: document.getElementById('serverUsername').value,
                password: document.getElementById('serverPassword').value
            };
            
            fetch('/api/servers/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverData)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            });
        }

        // 删除服务器
        function deleteServer(serverName) {
            if (!confirm(`确定要删除服务器 ${serverName} 吗？`)) return;
            
            fetch('/api/servers/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: serverName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        // 处理表单提交
        document.getElementById('serverForm').onsubmit = function(e) {
        
            e.preventDefault();
            
            const action = document.getElementById('serverAction').value;
            const serverData = {
                name: document.getElementById('serverName').value,
                host: document.getElementById('serverHost').value,
                port: document.getElementById('serverPort').value,
                username: document.getElementById('serverUsername').value,
                password: document.getElementById('serverPassword').value
            };
            
            fetch(`/api/servers/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        };

        // 更新历史记录
        function updateHistory() {
            fetch('/api/history')
                .then(response => response.json())
                .then(data => {
                    const historyList = document.getElementById('historyList');
                    if (!historyList) return;  // 添加检查

                    historyList.innerHTML = data.map(record => `
                        <div class="history-item">
                            <div class="history-info">
                                <div class="history-task">${record.task_name}</div>
                                <div class="history-time">${record.time}</div>
                            </div>
                            <div class="history-details">${record.details}</div>
                            <div class="history-status ${record.success ? 'success' : 'failed'}">
                                ${record.success ? '成功' : '失败'}
                            </div>
                        </div>
                    `).join('');
                });
        }

        // 显示添加任务对话框
        function showAddTaskDialog() {
            document.getElementById('taskDialogTitle').textContent = '添加任务';
            document.getElementById('taskAction').value = 'add';
            document.getElementById('taskForm').reset();
            document.getElementById('taskDialog').style.display = 'flex';
        }

        // 显示编辑任务对话框
        function editTask(taskName) {
            const task = tasks[taskName];
            document.getElementById('taskDialogTitle').textContent = '编辑任务';
            document.getElementById('taskAction').value = 'edit';
            document.getElementById('taskName').value = taskName;
            document.getElementById('sourcePath').value = task.source_path;
            document.getElementById('targetServer').value = task.target_server;
            document.getElementById('targetPath').value = task.target_path;
            document.getElementById('schedule').value = task.schedule;
            document.getElementById('retryTimes').value = task.retry_times;
            document.getElementById('retryInterval').value = task.retry_interval;
            document.getElementById('taskDialog').style.display = 'flex';
        }

        // 关闭任务对话框
        function closeTaskDialog() {
            document.getElementById('taskDialog').style.display = 'none';
        }

        // 处理任务表单提交
        document.getElementById('taskForm').onsubmit = function(e) {
            e.preventDefault();
            
            const action = document.getElementById('taskAction').value;
            const taskData = {
                name: document.getElementById('taskName').value,
                source_path: document.getElementById('sourcePath').value,
                target_server: document.getElementById('targetServer').value,
                target_path: document.getElementById('targetPath').value,
                schedule: document.getElementById('schedule').value,
                retry_times: parseInt(document.getElementById('retryTimes').value),
                retry_interval: parseInt(document.getElementById('retryInterval').value)
            };
            
            fetch(`/api/tasks/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        };

        // 定期更新历史记录
        setInterval(updateHistory, 10000);
        updateHistory();

        let dailyChart = null;
        let taskChart = null;

        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // 更新统计卡片
                    document.getElementById('totalBackups').textContent = data.total_backups;
                    document.getElementById('successRate').textContent = 
                        data.success_rate.toFixed(1) + '%';
                    
                    // 更新每日统计图表
                    const dates = Object.keys(data.daily_stats).reverse();
                    const successData = dates.map(date => data.daily_stats[date].success);
                    const failedData = dates.map(date => data.daily_stats[date].failed);
                    
                    if (dailyChart) dailyChart.destroy();
                    dailyChart = new Chart(document.getElementById('dailyChart'), {
                        type: 'bar',
                        data: {
                            labels: dates,
                            datasets: [
                                {
                                    label: '成功',
                                    data: successData,
                                    backgroundColor: '#4CAF50'
                                },
                                {
                                    label: '失败',
                                    data: failedData,
                                    backgroundColor: '#f44336'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '每日备份统计'
                                }
                            },
                            scales: {
                                x: { stacked: true },
                                y: { stacked: true }
                            }
                        }
                    });
                    
                    // 更新任务统计图表
                    const tasks = Object.keys(data.task_stats);
                    const taskSuccess = tasks.map(task => data.task_stats[task].success);
                    const taskFailed = tasks.map(task => data.task_stats[task].failed);
                    
                    if (taskChart) taskChart.destroy();
                    taskChart = new Chart(document.getElementById('taskChart'), {
                        type: 'bar',
                        data: {
                            labels: tasks,
                            datasets: [
                                {
                                    label: '成功',
                                    data: taskSuccess,
                                    backgroundColor: '#4CAF50'
                                },
                                {
                                    label: '失败',
                                    data: taskFailed,
                                    backgroundColor: '#f44336'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '任务备份统计'
                                }
                            },
                            scales: {
                                x: { stacked: true },
                                y: { stacked: true }
                            }
                        }
                    });
                });
        }

        // 定期更新统计信息
        setInterval(updateStats, 30000);
        updateStats();

        function showLoading(element) {
            const loading = document.createElement('div');
            loading.className = 'loading';
            element.appendChild(loading);
        }

        function hideLoading(element) {
            const loading = element.querySelector('.loading');
            if (loading) {
                loading.remove();
            }
        }

        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('notification-show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('notification-show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function clearHistory() {
            const historyList = document.getElementById('historyList');
            if (historyList) {
                historyList.innerHTML = '';
            }
        }

        function updateSystemStatus() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('获取系统状态失败:', data.error);
                        return;
                    }
                    
                    // 更新CPU使用率
                    const cpuElement = document.getElementById('cpuUsage');
                    if (cpuElement) {
                        cpuElement.textContent = `${Math.round(data.cpu_percent)}%`;
                        // 根据使用率改变颜色
                        if (data.cpu_percent > 80) {
                            cpuElement.style.color = '#f44336';  // 红色
                        } else if (data.cpu_percent > 60) {
                            cpuElement.style.color = '#ff9800';  // 橙色
                        } else {
                            cpuElement.style.color = '#4caf50';  // 绿色
                        }
                    }
                    
                    // 更新内存使用率
                    const memoryElement = document.getElementById('memoryUsage');
                    if (memoryElement) {
                        memoryElement.textContent = `${Math.round(data.memory.percent)}%`;
                        // 根据使用率改变颜色
                        if (data.memory.percent > 80) {
                            memoryElement.style.color = '#f44336';
                        } else if (data.memory.percent > 60) {
                            memoryElement.style.color = '#ff9800';
                        } else {
                            memoryElement.style.color = '#4caf50';
                        }
                    }
                    
                    // 更新磁盘使用率
                    const diskElement = document.getElementById('diskUsage');
                    if (diskElement) {
                        diskElement.textContent = `${Math.round(data.disk.percent)}%`;
                        // 根据使用率改变颜色
                        if (data.disk.percent > 80) {
                            diskElement.style.color = '#f44336';
                        } else if (data.disk.percent > 60) {
                            diskElement.style.color = '#ff9800';
                        } else {
                            diskElement.style.color = '#4caf50';
                        }
                    }
                    
                    // 更新备份状态
                    const backupStatus = document.getElementById('backupStatus');
                    if (backupStatus) {
                        if (data.backup_running) {
                            backupStatus.innerHTML = '<i class="mdi mdi-sync spin"></i> 备份中';
                            backupStatus.classList.add('status-running');
                        } else {
                            backupStatus.innerHTML = '<i class="mdi mdi-check-circle"></i> 空闲';
                            backupStatus.classList.remove('status-running');
                        }
                    }
                })
                .catch(error => {
                    console.error('获取系统状态出错:', error);
                });
        }

        // 更频繁地更新系统状态（每2秒）
        setInterval(updateSystemStatus, 2000);
        updateSystemStatus();
    </script>
</body>
</html> 